# ğŸŒŸ **TIME_WAIT status in TCP: Why is it needed and why is it important?** ğŸŒŸ  

The **`TIME_WAIT`** state is one of the most mysterious in TCP, but critically important for reliability. Let's figure it out!  

---

## ğŸ”¥ **What is TIME_WAIT?**  
When one side (usually **the client**) performs an **active closure** (`close()`), TCP enters the **`TIME_WAIT`** state and **holds `2MSL`** (where **MSL = Maximum Segment Lifetime**).  

ğŸ“Œ **MSL** is the maximum packet lifetime on the network (usually **30 secâ€“2 min**).  
ğŸ“Œ **2MSL** = **1-4 minutes** (on Linux, usually **60 seconds**).  

---

## â“ **Why do I need TIME_WAIT?**  

### 1ï¸âƒ£ **Guarantees reliable connection termination**  
- If the last **ACK** is lost, the server will resend **FIN**.  
- The client in **`TIME_WAIT'** will be able to resend **ACK** and avoid a "hanging" connection.  

### 2ï¸âƒ£ **Protects against "zombie packages"** ğŸ§Ÿ  
- **Old duplicate packets** may get stuck on the network (due to routing, loops, etc.).
- **`TIME_WAIT`** ensures that all such packets **disappear** before the port can be used again.  

> **Example:**  
> Let's say the connection `A:1500 â†’ B:21` is closed.  
> If you immediately reuse the same ports, **old packets** can get into the new connection and break everything!  

---

## âš ï¸ **Problems with TIME_WAIT**  
### **Is the server in TIME_WAIT?** This is usually **normal** (unless he is the initiator of the closure).  
### **Is the client in TIME_WAIT?** May end up with **ports** (if there are many connections).  

**Solution:**  
```c
int yes = 1;
setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(yes)); // Port reuse
```

---

## ğŸ“Š **TCP Status diagram (active closure)**  
```mermaid
stateDiagram-v2
    ESTABLISHED --> FIN_WAIT_1: close()
    FIN_WAIT_1 --> FIN_WAIT_2: ACK received
    FIN_WAIT_2 --> TIME_WAIT: FIN â†’ ACK received
    TIME_WAIT --> [*]: 2MSL timeout
```

---

## ğŸ’¡ **Exceptions (Berkeley TCP)**  
Some systems (such as Linux) **allow a new connection** from `TIME_WAIT` if:
âœ… **SYN number > last number of the previous connection**.  
ğŸ“Œ Is used in `rsh' (but not always safely, see RFC 1185).  

---

## ğŸš€ **Conclusion**  
* **`TIME_WAIT' = 2MSL** (usually **1-4 minutes**).  
, **Is needed for:**
- Reliable termination (if **ACK is lost**).  
   - Protection against **old packages**.  
âš ï¸ **Problems:** May interfere with frequent reconnections (treated by `SO_REUSEADDR').  

Do you want to take a deeper look at **Linux kernel settings** for `TIME_WAIT'? Write! ğŸ˜